{% extends "packages/base.html" %}

{% block title %}{{ package.name }} - ConanCrates{% endblock %}

{% block content %}
<div style="margin-bottom: 1rem;">
    <a href="{% url 'packages:package_list' %}" style="color: #3498db; text-decoration: none;">&larr; Back to packages</a>
</div>

<div class="card">
    <h1 style="margin-bottom: 0.5rem;">{{ package.name }}</h1>
    {% if package.author %}
    <p style="color: #666; margin-bottom: 1rem;">by {{ package.author }}</p>
    {% endif %}

    {% if package.description %}
    <p style="margin-bottom: 1.5rem;">{{ package.description }}</p>
    {% endif %}

    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
        {% if package.license %}
        <span class="tag license">License: {{ package.license }}</span>
        {% endif %}
        {% if package.homepage %}
        <a href="{{ package.homepage }}" target="_blank" class="tag" style="text-decoration: none; background: #e3f2fd; color: #1976d2;">Homepage</a>
        {% endif %}
        <span class="tag">{{ package.download_count }} downloads</span>
    </div>

    {% if topics %}
    <div style="margin-bottom: 1rem;">
        <strong>Topics:</strong>
        {% for topic in topics %}
        <span class="tag">{{ topic }}</span>
        {% endfor %}
    </div>
    {% endif %}
</div>

<div class="card">
    <h2>Versions</h2>
    <div style="margin-bottom: 1.5rem;">
        <label for="version-select" style="margin-right: 1rem;"><strong>Select version:</strong></label>
        <select id="version-select" onchange="window.location.href='?version='+this.value" style="padding: 8px; border: 2px solid #ddd; border-radius: 4px;">
            {% for version in versions %}
            <option value="{{ version.version }}" {% if version == selected_version %}selected{% endif %}>
                {{ version.version }} {% if version == versions.first %}(latest){% endif %}
            </option>
            {% endfor %}
        </select>
    </div>

    {% if selected_version %}
    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
        <p><strong>Version:</strong> {{ selected_version.version }}</p>
        {% if selected_version.recipe_revision %}
        <p><strong>Recipe Revision:</strong> <code style="background: white; padding: 2px 6px; border-radius: 3px;">{{ selected_version.recipe_revision }}</code></p>
        {% endif %}
        {% if selected_version.conan_version %}
        <p><strong>Conan Version:</strong> <code style="background: white; padding: 2px 6px; border-radius: 3px;">{{ selected_version.conan_version }}</code></p>
        {% endif %}
        <p><strong>Uploaded:</strong> {{ selected_version.created_at|date:"F d, Y" }}</p>
        {% if selected_version.uploaded_by %}
        <p><strong>By:</strong> {{ selected_version.uploaded_by.username }}</p>
        {% endif %}
    </div>
    {% endif %}
</div>

{% if selected_version %}
{% if binaries_with_deps %}
<div class="card">
    <h2>Available Binaries</h2>
    <p style="color: #666; margin-bottom: 1rem;">Pre-compiled binaries for version {{ selected_version.version }}</p>
    <table>
        <thead>
            <tr>
                <th>OS</th>
                <th>Architecture</th>
                <th>Compiler</th>
                <th>Build Type</th>
                <th>Dependencies</th>
                <th>Size</th>
                <th>Downloads</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for item in binaries_with_deps %}
            <tr>
                <td><span class="tag">{{ item.binary.os|default:"Any" }}</span></td>
                <td><span class="tag">{{ item.binary.arch|default:"Any" }}</span></td>
                <td>
                    {% if item.binary.compiler %}
                    {{ item.binary.compiler }}
                    {% if item.binary.compiler_version %}{{ item.binary.compiler_version }}{% endif %}
                    {% else %}
                    Any
                    {% endif %}
                </td>
                <td>
                    {% if item.binary.build_type == 'Release' %}
                    <span class="tag" style="background: #e8f5e9; color: #2e7d32;">{{ item.binary.build_type }}</span>
                    {% elif item.binary.build_type == 'Debug' %}
                    <span class="tag" style="background: #fff3e0; color: #e65100;">{{ item.binary.build_type }}</span>
                    {% else %}
                    <span class="tag">{{ item.binary.build_type|default:"Any" }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if item.dependencies %}
                    <details>
                        <summary style="cursor: pointer; color: #6a1b9a; font-weight: bold;">{{ item.dependencies|length }} package(s)</summary>
                        <ul style="list-style: none; padding: 0.5rem 0 0 0; margin: 0;">
                            {% for dep in item.dependencies %}
                            <li style="padding: 0.25rem 0;">
                                <a href="{% url 'packages:package_detail' dep.name %}" style="color: #6a1b9a; text-decoration: none;">
                                    {{ dep.name }}
                                </a>
                                <code style="background: #f8f9fa; padding: 2px 4px; border-radius: 3px; font-size: 0.85em;">{{ dep.version }}</code>
                            </li>
                            {% endfor %}
                        </ul>
                    </details>
                    {% else %}
                    <span style="color: #999;">None</span>
                    {% endif %}
                </td>
                <td>{{ item.binary.file_size|filesizeformat }}</td>
                <td>{{ item.binary.download_count }}</td>
                <td>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <!-- For Conan users: Use CLI -->
                        <details style="border-left: 3px solid #1976d2; padding: 0.5rem; background: #e3f2fd; border-radius: 4px;">
                            <summary style="cursor: pointer; font-weight: bold; color: #1976d2; font-size: 0.9rem;">
                                üîß Conan CLI
                            </summary>
                            <div style="margin-top: 0.5rem;">
                                <div style="font-size: 0.85rem; color: #333; margin-bottom: 0.25rem;">Profile settings:</div>
                                <pre style="background: #263238; color: #aed581; padding: 0.4rem; border-radius: 3px; margin: 0 0 0.5rem 0; font-size: 0.7rem; overflow-x: auto;"><code>[settings]
os={{ item.binary.os }}
arch={{ item.binary.arch }}
compiler={{ item.binary.compiler }}
compiler.version={{ item.binary.compiler_version }}
build_type={{ item.binary.build_type }}</code></pre>
                                <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.25rem;">Save as: <code style="background: white; padding: 1px 3px; border-radius: 2px; font-size: 0.7rem;">~/.conan2/profiles/{{ item.binary.os|lower }}_{{ item.binary.compiler }}{{ item.binary.compiler_version }}_{{ item.binary.build_type|lower }}</code></div>
                                <div style="font-size: 0.85rem; color: #333; margin-bottom: 0.25rem;">Download:</div>
                                <pre style="background: #263238; color: #aed581; padding: 0.4rem; border-radius: 3px; margin: 0; font-size: 0.7rem; overflow-x: auto;"><code>python conancrates.py download {{ package.name }}/{{ selected_version.version }} -pr {{ item.binary.os|lower }}_{{ item.binary.compiler }}{{ item.binary.compiler_version }}_{{ item.binary.build_type|lower }}</code></pre>
                            </div>
                        </details>

                        <!-- Direct Downloads by Ecosystem -->
                        <div style="border-left: 3px solid #2e7d32; padding: 0.5rem; background: #e8f5e9; border-radius: 4px;">
                            <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; align-items: flex-start;">
                                <!-- Rust -->
                                <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                    <div style="font-size: 0.7rem; color: #666; font-weight: bold;">Rust:</div>
                                    <a href="{% url 'packages:download_rust_crate' package.name selected_version.version item.binary.package_id %}"
                                       style="color: #d84315; text-decoration: none; font-weight: bold; font-size: 0.85rem;"
                                       title="Download Rust -sys crate (.crate archive)">
                                       ü¶Ä Crate
                                    </a>
                                </div>

                                <!-- CMake -->
                                <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                    <div style="font-size: 0.7rem; color: #666; font-weight: bold;">CMake:</div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <a href="{% url 'packages:download_extracted_binary' package.name selected_version.version item.binary.package_id %}"
                                           style="color: #1565c0; text-decoration: none; font-weight: bold; font-size: 0.85rem;"
                                           title="Download with CMake configs (include/, lib/, cmake/)">
                                           ‚öôÔ∏è Pkg
                                        </a>
                                        <span style="color: #ddd;">|</span>
                                        <a href="{% url 'packages:download_extracted_bundle' package.name selected_version.version %}?os={{ item.binary.os }}&arch={{ item.binary.arch }}&compiler={{ item.binary.compiler }}&compiler_version={{ item.binary.compiler_version }}&build_type={{ item.binary.build_type }}"
                                           style="color: #1565c0; text-decoration: none; font-weight: bold; font-size: 0.85rem;"
                                           title="Bundle with dependencies for CMake">
                                           üóÇÔ∏è Bundle
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if selected_version.recipe_content %}
<div class="card" style="background: #e3f2fd;">
    <h2>üìÑ Recipe (conanfile.py)</h2>
    <p style="margin-bottom: 1rem;">View or download the Conan recipe for this package:</p>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
        <a href="{% url 'packages:view_recipe' package.name selected_version.version %}"
           target="_blank"
           class="btn" style="background: #1976d2;">
           View Recipe
        </a>
        <a href="{% url 'packages:download_recipe' package.name selected_version.version %}"
           class="btn" style="background: #0d47a1;">
           Download conanfile.py
        </a>
    </div>
    <details style="margin-top: 1rem;">
        <summary style="cursor: pointer; font-weight: bold; margin-bottom: 0.5rem;">Show Recipe Content</summary>
        <pre style="background: #263238; color: #aed581; padding: 1rem; border-radius: 4px; overflow-x: auto; max-height: 400px; overflow-y: auto;"><code>{{ selected_version.recipe_content }}</code></pre>
    </details>
</div>
{% endif %}

<div class="card" style="background: #fff3e0;">
    <h2>üì¶ Using with Conan</h2>
    <p style="margin-bottom: 1rem;">For Conan development workflows, use the ConanCrates CLI to download and use packages:</p>

    <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">1. Download from ConanCrates:</h3>
    <pre style="background: #263238; color: #aed581; padding: 1rem; border-radius: 4px; overflow-x: auto;"><code>python conancrates.py download {{ package.name }}/{{ selected_version.version }}</code></pre>
    <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Downloads recipe (conanfile.py) + binary packages to <code>./conan_packages/{{ package.name }}-{{ selected_version.version }}/</code></p>

    <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; margin-top: 1.5rem;">2. Add to your project's <strong>conanfile.txt</strong>:</h3>
    <pre style="background: #2c3e50; color: #ecf0f1; padding: 1rem; border-radius: 4px; overflow-x: auto;"><code>[requires]
{{ package.name }}/{{ selected_version.version }}</code></pre>

    <p style="margin: 1rem 0 0.5rem 0;">Or in your <strong>conanfile.py</strong>:</p>
    <pre style="background: #2c3e50; color: #ecf0f1; padding: 1rem; border-radius: 4px; overflow-x: auto;"><code>class MyProject(ConanFile):
    requires = "{{ package.name }}/{{ selected_version.version }}"</code></pre>

    <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; margin-top: 1.5rem;">Upload to ConanCrates:</h3>
    <pre style="background: #263238; color: #aed581; padding: 1rem; border-radius: 4px; overflow-x: auto;"><code>python conancrates.py upload {{ package.name }}/{{ selected_version.version }}</code></pre>
</div>
{% endif %}
{% endblock %}
